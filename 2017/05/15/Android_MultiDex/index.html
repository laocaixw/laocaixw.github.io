<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.9.0">
    <title>Android方法数超限问题探究与启动优化 - laocaixw</title>
    <meta charset="UTF-8">
<meta content="width=device-width, initial-scale=1.0, user-scalable=no" name="viewport">
<meta content="text/html; charset=utf-8" http-equiv="content-type">
<link href="/img/avatar.png" rel="shortcut icon">
<link href="undefined" rel="alternate" type="application/rss+xml">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/responsive.css">
<script src="/js/jquery.js"></script>
<script src="/js/basics.js"></script>


  </head>
  <body>
    <header>
  <a id="go-back-home" href="/"><img src="/img/avatar.png" alt="Home" width="60" height="60"></a>
  <p>laocaixw</p>
  <p>Android Developer</p>
</header>

    <div id="container">
      <div class="block">
  
    <a class="main" href="/">Home</a>
  
    <a class="main" href="https://github.com/laocaixw">Github</a>
  
    <a class="main" href="mailto:laocaixw@163.com">Email</a>
  
    <a class="main" href="/about/">About</a>
  
    <a class="main" href="/atom.xml">RSS</a>
  
</div>

      <section class="paging">
  
    <div class="left">
      <a href="/2017/06/11/Android_MultiChannel_APK/">
        ‹
      </a>
    </div>
  
  
    <div class="right">
      <a href="/2017/05/12/Android_Permission_Apply/">
        ›
      </a>
    </div>
  
</section>

      <div class="content">
        <section class="post">
          <h1>
            <div class="date">2017-05-15</div>
            Android方法数超限问题探究与启动优化
          </h1>
          <blockquote>
          <p><strong><a href="http://blog.laocaixw.cn/">转载请声明出处</a></strong></p>
          </blockquote>
          <p>前段时间写了篇有关<a href="/2017/02/28/Eclipse_Convert_Android_Studio/">Eclipse工程转Android Studio工程</a>的文章，而导致公司项目需要转 AS 的直接原因，就是今天要写的主题–方法数超限，相信大多数 Android 项目的都会碰到这个问题。</p>
<p>传统的 Eclipse 解决方法数超限的办法，就是在 project.properties 中加上 dex.force.jumbo=true ，然后清理工程重新编译。但是，当方法数越来越多，这个方法也会解决不了问题，这个时候，就要用到 Google 官方给出的方案 <a href="https://developer.android.google.cn/studio/build/multidex.html" target="_blank" rel="noopener">MultiDex</a> 了。</p>
<h2 id="MultiDex-解决方案"><a href="#MultiDex-解决方案" class="headerlink" title="MultiDex 解决方案"></a>MultiDex 解决方案</h2><p>一、 如果你的 minSdkVersion &gt;= 21 ，那么只要在模块的 build.gradle 中添加：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>二、 如果你的 minSdkVersion &lt; 21 ，那么只要在模块的 build.gradle 中添加：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span> <span class="string">'com.android.support:multidex:1.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，如果你没有写自己的 Application 类，那么你只要写上自己的 Application 类，并继承 MultiDexApplication ；如果你写过自己的 Application 类，并且/或者不希望 Application 类继承 MultiDexApplication ，那么你需要重写 Application 的 attachBaseContext 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.attachBaseContext(context);</span><br><span class="line">   Multidex.install(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动优化"><a href="#启动优化" class="headerlink" title="启动优化"></a>启动优化</h2><p>官方的解决方案虽然简单，但是也存在一定的局限。比如，首次加载应用时，由于需要加载 DEX 文件，会消耗较多的时间，导致启动速度慢，影响用户体验，甚至很可能引发 ANR 。</p>
<p>针对加载 Dex 问题，美团技术团队是这样做的：精简主 Dex 包，应用启动起来后再异步加载第二个 Dex 包。这是一个很不错的想法，但是实现起来有一定的难度。需要编写脚本，区分哪些类要放在主 Dex 包中，而且一般项目中都会用到很多第三方 SDK，这很可能导致主 Dex 包的精简程度不能达到我们想要的状态。</p>
<p>当然，除此之外，还有更适合我们的方案，微信开发团队的解决思路就很有意思，他们逆了不少 APP，最后参考并改进了 Facebook 的解决方案。大概的思路就是，新开一个<strong>进程</strong>来执行 Multidex.install() 方法。</p>
<p>微信开发团队的思路实现起来也比较简单，下面直接上我的代码（顺便把启动体验也优化了~）：</p>
<p>Application 中的 attachBaseContext 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.attachBaseContext(context);</span><br><span class="line">    <span class="keyword">if</span> (MultiDexUtils.isMainProcess(context)) &#123; <span class="comment">// 判断是否是主进程，避免重复执行</span></span><br><span class="line">        MultiDexUtils.setMainActivityStarted(<span class="keyword">this</span>, <span class="keyword">false</span>); <span class="comment">// 保存本地数据，标记主页面是否已经开启</span></span><br><span class="line">        MultiDexUtils.setLoadDexActivityClosed(<span class="keyword">this</span>, <span class="keyword">false</span>); <span class="comment">// 保存本地数据，标记加载Dex进程是否已经关闭</span></span><br><span class="line">        MultiDexUtils.startLoadDexActivity(context); <span class="comment">// 打开加载 Dex 的进程页面，这样我们的APP就变成后台进程了</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载 Dex 的进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadDexActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MULTIDEX_ERROR = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MULTIDEX_ACTIVITY_STARTED = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Handler handler = <span class="keyword">new</span> Handler() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">                <span class="keyword">case</span> MULTIDEX_ERROR:</span><br><span class="line">                <span class="keyword">case</span> MULTIDEX_ACTIVITY_STARTED: <span class="comment">// 退出当前进程</span></span><br><span class="line">                    MultiDexUtils.setLoadDexActivityClosed(getApplication());</span><br><span class="line">                    finish();</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_loaddex);</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">            getWindow().addFlags(WindowManager.LayoutParams.FLAG_TRANSLUCENT_STATUS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Message message = handler.obtainMessage();</span><br><span class="line">                <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">long</span> timeout = <span class="number">10</span> * <span class="number">1000</span>; <span class="comment">// 加载超时时间</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MultiDex.install(getApplication());</span><br><span class="line">                    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">                    <span class="comment">// 等待主界面启动</span></span><br><span class="line">                    <span class="keyword">while</span> (!MultiDexUtils.isMainActivityStarted(getApplication()) &amp;&amp;</span><br><span class="line">                            (System.currentTimeMillis() - startTime) &lt; timeout) &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    message.what = MULTIDEX_ACTIVITY_STARTED;</span><br><span class="line">                    handler.sendMessage(message);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    message.what = MULTIDEX_ERROR;</span><br><span class="line">                    handler.sendMessage(message);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//cannot backpress</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Manifest 中 LoadDexActivity 的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".LoadDexActivity"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:alwaysRetainTaskState</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:excludeFromRecents</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:launchMode</span>=<span class="string">"singleTask"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">":loadDex"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">"portrait"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>主界面 onCreate 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">	...</span><br><span class="line">	MultiDexUtils.setMainActivityStarted(getApplication()); <span class="comment">// 告诉loadDex进程，主界面已启动</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MultiDexUtils 工具类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiDexUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_ACTIVITY_STARTED = <span class="string">"activity-started-"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_LOADDEX_CLOSED = <span class="string">"loaddex-closed-"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前进程是否是主进程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMainProcess</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"com.***.***(进程名一般是包名)"</span>.equals(getCurProcessName(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置-主界面已经打开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMainActivityStarted</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        setMainActivityStarted(context, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置-主界面是否已经打开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setMainActivityStarted</span><span class="params">(Context context, <span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(<span class="string">"multidex"</span>, Context.MODE_MULTI_PROCESS);</span><br><span class="line">        sp.edit().putBoolean(KEY_ACTIVITY_STARTED + getPackageInfo(context).versionCode, b).commit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否需要等待主界面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMainActivityStarted</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(<span class="string">"multidex"</span>, Context.MODE_MULTI_PROCESS);</span><br><span class="line">        <span class="keyword">return</span> sp.getBoolean(KEY_ACTIVITY_STARTED + getPackageInfo(context).versionCode, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断加载页面是否关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLoadDexActivityClosed</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(<span class="string">"multidex"</span>, Context.MODE_MULTI_PROCESS);</span><br><span class="line">        <span class="keyword">return</span> sp.getBoolean(KEY_LOADDEX_CLOSED + getPackageInfo(context).versionCode, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置加载页面已经关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLoadDexActivityClosed</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        setLoadDexActivityClosed(context, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置-加载页面是否已经关闭</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setLoadDexActivityClosed</span><span class="params">(Context context, <span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">        SharedPreferences sp = context.getSharedPreferences(<span class="string">"multidex"</span>, Context.MODE_MULTI_PROCESS);</span><br><span class="line">        sp.edit().putBoolean(KEY_LOADDEX_CLOSED + getPackageInfo(context).versionCode, b).commit();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启等待页面，新的进程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startLoadDexActivity</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">        ComponentName componentName = <span class="keyword">new</span> ComponentName(<span class="string">"com.***.***(包名)"</span>, LoadDexActivity.class.getName());</span><br><span class="line">        intent.setComponent(componentName);</span><br><span class="line">        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        context.startActivity(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取进程名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCurProcessName</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> pid = android.os.Process.myPid();</span><br><span class="line">            ActivityManager mActivityManager = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</span><br><span class="line">            <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo appProcess : mActivityManager.getRunningAppProcesses()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (appProcess.pid == pid) &#123;</span><br><span class="line">                    <span class="keyword">return</span> appProcess.processName;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取包信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PackageInfo <span class="title">getPackageInfo</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        PackageManager pm = context.getPackageManager();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pm.getPackageInfo(context.getPackageName(), <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line"><span class="comment">//            Log.i(TAG, e.getLocalizedMessage());</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PackageInfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="另一种启动优化方案"><a href="#另一种启动优化方案" class="headerlink" title="另一种启动优化方案"></a>另一种启动优化方案</h2><p>还有一种简单的启动优化方案，只能优化启动体验，并不能解决 ANR 问题。</p>
<p>在点击桌面图标启动应用时，给个背景图片，启动完成后，将背景设回空。</p>
<p>1.在入口 Activity 中加入主题背景</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">android:theme=&quot;@style/SplashTheme&quot;</span><br></pre></td></tr></table></figure>
<p>style.xml 中加入配置：</p>
<p>value:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style name=&quot;SplashTheme&quot; parent=&quot;@android:style/Theme.NoTitleBar&quot;&gt;</span><br><span class="line">    &lt;item name=&quot;android:background&quot;&gt;@drawable/logo_splash&lt;/item&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>value-v21:(解决21版本及以上的过度动画效果问题)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style name=&quot;SplashTheme&quot; parent=&quot;@android:style/Theme.NoTitleBar.Fullscreen&quot;&gt;</span><br><span class="line">    &lt;item name=&quot;android:windowBackground&quot;&gt;@drawable/logo_splash&lt;/item&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>2.将背景设回原样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void setTheme(int resid) &#123;</span><br><span class="line">    super.setTheme(R.style.CustomTransparent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>style.xml 配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;style name=&quot;CustomTransparent&quot; parent=&quot;@android:style/Theme.Translucent&quot;&gt;</span><br><span class="line">    &lt;item name=&quot;android:background&quot;&gt;@null&lt;/item&gt;</span><br><span class="line">    &lt;item name=&quot;android:windowBackground&quot;&gt;@color/curve_floater_frameColor&lt;/item&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.open-open.com/lib/view/open1452264136714.html" target="_blank" rel="noopener">其实你不知道 MultiDex 到底有多坑</a></p>
<p><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="noopener">美团 Android DEX 自动拆包及动态加载简介</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=207151651&amp;idx=1&amp;sn=9eab282711f4eb2b4daf2fbae5a5ca9a&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd" target="_blank" rel="noopener">Android 拆分与加载 Dex 的多种方案对比</a></p>
<p><a href="https://developer.android.google.cn/studio/build/multidex.html" target="_blank" rel="noopener">配置方法数超过 64K 的应用</a></p>

          
        </section>
      </div>
      
      
        <div id="comment-container"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
var gitment = new Gitment({
  // id: location.href, // 可选。默认为 location.href
  id: 'Android方法数超限问题探究与启动优化',
  owner: 'laocaixw', // 你的 GitHub ID
  repo: 'laocaixw.github.io', // 存储评论的 repo
  oauth: {
    client_id: 'b41a264d7724fd5a364b', // 你的 client ID
    client_secret: '9dc474e16291d40597b0ad55daae84c24eb41160', // 你的 client secret
  },
})
gitment.render('comment-container')
</script>
      
      <div class="block">
  
    <a class="main" href="/">Home</a>
  
    <a class="main" href="https://github.com/laocaixw">Github</a>
  
    <a class="main" href="mailto:laocaixw@163.com">Email</a>
  
    <a class="main" href="/about/">About</a>
  
    <a class="main" href="/atom.xml">RSS</a>
  
</div>

    </div>
    <footer>
  <span class="muted">&copy; laocaixw. All Rights Reserved.</span><br>
  <a href="https://github.com/saintwinkle/hexo-theme-scribble" class="muted">built with Hexo using Scribble theme</a>
  <br>
  <br>
</footer>

  </body>
</html>
